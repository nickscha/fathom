#ifndef FATHOM_MATH_BASIC_H
#define FATHOM_MATH_BASIC_H

#include "fathom_types.h"

/* #############################################################################
 * # [SECTION] Basic Math (SIMD Detection)
 * #############################################################################
 */
#ifdef FATHOM_DISABLE_SIMD
#include "fathom_math_basic_scalar.h"
#elif defined(FATHOM_ARCH_X64)
#include "fathom_math_basic_sse2.h"
#endif

/* #############################################################################
 * # [SECTION] Basic Math (General, No faster SIMD substitution)
 * #############################################################################
 */
#define FATHOM_PI 3.14159265358979323846f
#define FATHOM_PI2 6.28318530717958647692f
#define FATHOM_PI_HALF 1.57079632679489661923f
#define FATHOM_DEG_TO_RAD(deg) ((deg) * (FATHOM_PI / 180.0f))
#define FATHOM_RAD_TO_DEG(rad) ((rad) * (180.0f / FATHOM_PI))

#define FATHOM_SIN_LUT_SIZE 256

static f32 fathom_sin_lut[FATHOM_SIN_LUT_SIZE] = {
    0.0000f, 0.0245f, 0.0491f, 0.0736f, 0.0980f, 0.1224f, 0.1467f, 0.1710f,
    0.1951f, 0.2191f, 0.2430f, 0.2667f, 0.2903f, 0.3137f, 0.3369f, 0.3599f,
    0.3827f, 0.4052f, 0.4276f, 0.4496f, 0.4714f, 0.4929f, 0.5141f, 0.5350f,
    0.5556f, 0.5758f, 0.5957f, 0.6152f, 0.6344f, 0.6532f, 0.6716f, 0.6895f,
    0.7071f, 0.7242f, 0.7409f, 0.7572f, 0.7730f, 0.7883f, 0.8032f, 0.8176f,
    0.8315f, 0.8449f, 0.8577f, 0.8701f, 0.8819f, 0.8932f, 0.9040f, 0.9142f,
    0.9239f, 0.9330f, 0.9415f, 0.9495f, 0.9569f, 0.9638f, 0.9700f, 0.9757f,
    0.9808f, 0.9853f, 0.9892f, 0.9925f, 0.9952f, 0.9973f, 0.9988f, 0.9997f,
    1.0000f, 0.9997f, 0.9988f, 0.9973f, 0.9952f, 0.9925f, 0.9892f, 0.9853f,
    0.9808f, 0.9757f, 0.9700f, 0.9638f, 0.9569f, 0.9495f, 0.9415f, 0.9330f,
    0.9239f, 0.9142f, 0.9040f, 0.8932f, 0.8819f, 0.8701f, 0.8577f, 0.8449f,
    0.8315f, 0.8176f, 0.8032f, 0.7883f, 0.7730f, 0.7572f, 0.7409f, 0.7242f,
    0.7071f, 0.6895f, 0.6716f, 0.6532f, 0.6344f, 0.6152f, 0.5957f, 0.5758f,
    0.5556f, 0.5350f, 0.5141f, 0.4929f, 0.4714f, 0.4496f, 0.4276f, 0.4052f,
    0.3827f, 0.3599f, 0.3369f, 0.3137f, 0.2903f, 0.2667f, 0.2430f, 0.2191f,
    0.1951f, 0.1710f, 0.1467f, 0.1224f, 0.0980f, 0.0736f, 0.0491f, 0.0245f,
    0.0000f, -0.0245f, -0.0491f, -0.0736f, -0.0980f, -0.1224f, -0.1467f, -0.1710f,
    -0.1951f, -0.2191f, -0.2430f, -0.2667f, -0.2903f, -0.3137f, -0.3369f, -0.3599f,
    -0.3827f, -0.4052f, -0.4276f, -0.4496f, -0.4714f, -0.4929f, -0.5141f, -0.5350f,
    -0.5556f, -0.5758f, -0.5957f, -0.6152f, -0.6344f, -0.6532f, -0.6716f, -0.6895f,
    -0.7071f, -0.7242f, -0.7409f, -0.7572f, -0.7730f, -0.7883f, -0.8032f, -0.8176f,
    -0.8315f, -0.8449f, -0.8577f, -0.8701f, -0.8819f, -0.8932f, -0.9040f, -0.9142f,
    -0.9239f, -0.9330f, -0.9415f, -0.9495f, -0.9569f, -0.9638f, -0.9700f, -0.9757f,
    -0.9808f, -0.9853f, -0.9892f, -0.9925f, -0.9952f, -0.9973f, -0.9988f, -0.9997f,
    -1.0000f, -0.9997f, -0.9988f, -0.9973f, -0.9952f, -0.9925f, -0.9892f, -0.9853f,
    -0.9808f, -0.9757f, -0.9700f, -0.9638f, -0.9569f, -0.9495f, -0.9415f, -0.9330f,
    -0.9239f, -0.9142f, -0.9040f, -0.8932f, -0.8819f, -0.8701f, -0.8577f, -0.8449f,
    -0.8315f, -0.8176f, -0.8032f, -0.7883f, -0.7730f, -0.7572f, -0.7409f, -0.7242f,
    -0.7071f, -0.6895f, -0.6716f, -0.6532f, -0.6344f, -0.6152f, -0.5957f, -0.5758f,
    -0.5556f, -0.5350f, -0.5141f, -0.4929f, -0.4714f, -0.4496f, -0.4276f, -0.4052f,
    -0.3827f, -0.3599f, -0.3369f, -0.3137f, -0.2903f, -0.2667f, -0.2430f, -0.2191f,
    -0.1951f, -0.1710f, -0.1467f, -0.1224f, -0.0980f, -0.0736f, -0.0491f, -0.0245f};

FATHOM_API FATHOM_INLINE f32 fathom_sinf(f32 x)
{
    f32 index, frac;
    i32 i, i2;

    x -= FATHOM_PI2 * (f32)((i32)(x * (1.0f / FATHOM_PI2)));

    if (x < 0)
    {
        x += FATHOM_PI2;
    }

    index = x * (FATHOM_SIN_LUT_SIZE / FATHOM_PI2);
    i = (i32)index;
    frac = index - (f32)i;

    i &= (FATHOM_SIN_LUT_SIZE - 1);
    i2 = (i + 1) & (FATHOM_SIN_LUT_SIZE - 1);

    return fathom_sin_lut[i] + frac * (fathom_sin_lut[i2] - fathom_sin_lut[i]);
}

FATHOM_API FATHOM_INLINE f32 fathom_cosf(f32 x)
{
    return fathom_sinf(x + FATHOM_PI_HALF);
}

FATHOM_API FATHOM_INLINE f32 fathom_sinf_snorm(f32_snorm a)
{
    static f32 a0 = +1.91059300966915117e-31f;
    static f32 a1 = +1.00086760103908896f;
    static f32 a2 = -1.21276126894734565e-2f;
    static f32 a3 = -1.38078780785773762e-1f;
    static f32 a4 = -2.67353392911981221e-2f;
    static f32 a5 = +2.08026600266304389e-2f;
    static f32 a6 = -3.03996055049204407e-3f;
    static f32 a7 = +1.38235642404333740e-4f;
    return a0 + a * (a1 + a * (a2 + a * (a3 + a * (a4 + a * (a5 + a * (a6 + a * a7))))));
}

FATHOM_API FATHOM_INLINE f32 fathom_cosf_snorm(f32_snorm a)
{
    static f32 a0 = +1.00238601909309722f;
    static f32 a1 = -3.81919947353040024e-2f;
    static f32 a2 = -3.94382342128062756e-1f;
    static f32 a3 = -1.18134036025221444e-1f;
    static f32 a4 = +1.07123798512170878e-1f;
    static f32 a5 = -1.86637164165180873e-2f;
    static f32 a6 = +9.90140908664079833e-4f;
    static f32 a7 = -5.23022132118824778e-14f;
    return a0 + a * (a1 + a * (a2 + a * (a3 + a * (a4 + a * (a5 + a * (a6 + a * a7))))));
}

FATHOM_API FATHOM_INLINE f32 fathom_sminf(f32 a, f32 b, f32 k)
{
    f32 h = fathom_maxf(k - fathom_absf(a - b), 0.0f) / k;
    return fathom_minf(a, b) - h * h * h * k * (1.0f / 6.0f);
}

#endif /* FATHOM_MATH_BASIC_H */